<?php

/**
 * @file
 * Alternative Pager.
 *
 * API for alternative pager. It is alternative view point on
 * Pager functionality.
 */

/**
 * Implements hook_theme().
 */
function altpager_theme() {
  return array(
    'altpager' => array(
      'variables' => array(
        'total' => 0,
        'items' => '',
      ),
      'template' => 'altpager',
    ),
    'altpager_link' => array(
      'variables' => array(
        'count' => 0,
        'title' => '',
      ),
    ),
  );
}

/**
 * Default items count pager.
 *
 * @return array
 *   Array list items.
 */
function altpager_default_items() {
  $max_count = altpager_count_all_items();

  return array(
    10 => 10,
    20 => 20,
    50 => 50,
    100 => 100,
    200 => 200,
    400 => 400,
    600 => 600,
    $max_count => $max_count,
  );
}

/**
 * Get/Set count all items.
 *
 * @param mixed $count
 *   Count all items.
 *
 * @return bool
 */
function altpager_count_all_items($count = FALSE) {
  static $items_count;

  if ($count) {
    $items_count = $count;
  }

  return $items_count;
}

/**
 * Count items viewed in current page.
 *
 * @return int|mixed
 *   Count items viewed.
 */
function altpager_count_items_viewed() {
  $max_count = altpager_count_all_items();

  $default_items = altpager_default_items();
  $min_count_items = key($default_items);

  $count = isset($_GET['apcount']) ? (int) $_GET['apcount'] : $min_count_items;

  if ($count > $max_count || $count < 0) {
    $count = $max_count;
  }

  if (!in_array($count, $default_items)) {
    $count = $min_count_items;
  }

  return $count;
}

/**
 * Process variables for altpager.tpl.php.
 *
 * The $variables array contains the following arguments:
 * - $total: Count all items.
 * - $items: Items for output.
 *
 * @see altpager.tpl.php
 */
function template_preprocess_altpager(&$variables) {
  $max_count = altpager_count_all_items();

  drupal_add_css(drupal_get_path('module', 'altpager') . '/altpager.css');

  $variables['items'] = '';
  $items = altpager_default_items();
  $min_count = key($items);

  if ($max_count > $min_count) {
    foreach ($items as $count => $title) {
      if ($count <= $max_count) {
        $variables['items'] .= theme('altpager_link', array(
          'count' => $count,
          'title' => $title,
        ));
      }
    }
  }

  $variables['total'] = $max_count;
}

/**
 * Link theme.
 *
 * @param array $variables
 *   An associative array containing:
 *   - count: Count items viewed.
 *   - text: Item title.
 *
 * @return string
 *   Link.
 */
function theme_altpager_link($variables) {
  $query = array();
  $query['apcount'] = $variables['count'];
  $cookie = isset($_COOKIE) ? $_COOKIE : array();

  $exclude = array_merge(array('q', 'apcount', 'pass'), array_keys($cookie));
  $querystring = drupal_get_query_parameters($_GET, $exclude);

  if (!empty($querystring)) {
    $query = array_merge($querystring, $query);
  }

  $count_items = altpager_count_items_viewed();

  if ($count_items == $variables['count']) {
    $output = '<li class="active">' . $variables['title'] . '</li>';
  }
  else {
    $output = '<li>' . l($variables['title'], $_GET['q'], array('query' => $query)) . '</li>';
  }

  return $output;
}

/**
 * Query extender for pager queries.
 */
class AltPager extends SelectQueryExtender {

  public function __construct(SelectQueryInterface $query, DatabaseConnection $connection) {
    parent::__construct($query, $connection);

    $this->addTag('altpager');
  }

  /**
   * Override the execute method.
   *
   * Before we run the query, we need to add pager-based range() instructions
   * to it.
   */
  public function execute() {
    $max_count = $this
      ->query
      ->countQuery()
      ->execute()
      ->fetchField();

    altpager_count_all_items($max_count);

    $count_items = altpager_count_items_viewed();

    $this->range(0, $count_items);

    return $this->query->execute();
  }
}
